#!/bin/bash
# Enhanced history command with better functionality

# Source shell functions if available
if [[ -f "$HOME/.local/lib/shell_functions.sh" ]]; then
  source "$HOME/.local/lib/shell_functions.sh"
fi

# Define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if history command exists
if command -v history &>/dev/null; then
  # Check for command options
  case "$1" in
    -c|--clear)
      # Clear history
      history -c
      echo -e "${GREEN}Command history cleared.${NC}"
      exit 0
      ;;
    -h|--help)
      echo -e "${BLUE}Enhanced history command${NC}"
      echo
      echo "Usage: history [OPTION]"
      echo
      echo "Options:"
      echo "  -c, --clear    Clear the history list"
      echo "  -h, --help     Display this help and exit"
      echo "  -s, --search   Search history for a pattern"
      echo "  -n NUM         Show only the last NUM lines"
      echo
      echo "Examples:"
      echo "  history        Show command history"
      echo "  history -c     Clear history"
      echo "  history -s ls  Search for 'ls' in history"
      echo "  history -n 10  Show last 10 commands"
      exit 0
      ;;
    -s|--search)
      if [ -z "$2" ]; then
        echo -e "${RED}Error: No search pattern specified${NC}"
        echo "Usage: history -s PATTERN"
        exit 1
      fi
      # Search history
      history | grep -i "$2"
      exit 0
      ;;
    -n)
      if [ -z "$2" ] || ! [[ "$2" =~ 
^
[0-9]+$ ]]; then
        echo -e "${RED}Error: Invalid number of lines${NC}"
        echo "Usage: history -n NUM"
        exit 1
      fi
      # Show last N lines
      history "$2"
      exit 0
      ;;
    *)
      # Default behavior
      history "$@"
      exit 0
      ;;
  esac
else
  # If no system history command, simulate one using .bash_history
  if [ -f "$HOME/.bash_history" ]; then
    case "$1" in
      -c|--clear)
        # Clear history
        > "$HOME/.bash_history"
        echo -e "${GREEN}Command history cleared.${NC}"
        exit 0
        ;;
      -h|--help)
        echo -e "${BLUE}Simulated history command${NC}"
        echo
        echo "Usage: history [OPTION]"
        echo
        echo "Options:"
        echo "  -c, --clear    Clear the history list"
        echo "  -h, --help     Display this help and exit"
        echo "  -s, --search   Search history for a pattern"
        echo "  -n NUM         Show only the last NUM lines"
        echo
        echo "Examples:"
        echo "  history        Show command history"
        echo "  history -c     Clear history"
        echo "  history -s ls  Search for 'ls' in history"
        echo "  history -n 10  Show last 10 commands"
        exit 0
        ;;
      -s|--search)
        if [ -z "$2" ]; then
          echo -e "${RED}Error: No search pattern specified${NC}"
          echo "Usage: history -s PATTERN"
          exit 1
        fi
        # Search history
        grep -i "$2" "$HOME/.bash_history" | cat -n
        exit 0
        ;;
      -n)
        if [ -z "$2" ] || ! [[ "$2" =~ 
^
[0-9]+$ ]]; then
          echo -e "${RED}Error: Invalid number of lines${NC}"
          echo "Usage: history -n NUM"
          exit 1
        fi
        # Show last N lines
        tail -n "$2" "$HOME/.bash_history" | cat -n
        exit 0
        ;;
      *)
        # Default behavior - show all history with line numbers
        cat -n "$HOME/.bash_history"
        exit 0
        ;;
    esac
  else
    echo -e "${RED}No command history available.${NC}"
    echo "Command history will be accumulated as you use the terminal."
    exit 1
  fi
fi
